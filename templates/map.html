{% extends "base.html" %}

{% block title %}Map View - OSM Map Processor{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    .map-controls {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .legend {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .legend-color {
        width: 20px;
        height: 15px;
        margin-right: 10px;
        border: 1px solid #ccc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-lg-12 text-center">
            <h1 class="display-5 mb-3">
                <i class="fas fa-map"></i> Map View
            </h1>
            <p class="lead">Interactive visualization of your OSM data</p>
        </div>
    </div>

    <!-- Map Controls -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="map-controls">
                <h5 class="mb-3"><i class="fas fa-cog"></i> Display Options</h5>
                
                <!-- Basic Infrastructure -->
                <div class="row mb-3">
                    <div class="col-lg-12">
                        <h6 class="text-primary"><i class="fas fa-building"></i> Infrastructure</h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showBuildings" checked data-layer="buildings">
                            <label class="form-check-label" for="showBuildings">
                                <i class="fas fa-building"></i> Buildings
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showRoads" checked data-layer="roads">
                            <label class="form-check-label" for="showRoads">
                                <i class="fas fa-road"></i> Roads
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showWaterways" data-layer="waterways">
                            <label class="form-check-label" for="showWaterways">
                                <i class="fas fa-water"></i> Waterways
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Education -->
                <div class="row mb-3">
                    <div class="col-lg-12">
                        <h6 class="text-success"><i class="fas fa-graduation-cap"></i> Education</h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showEducation" data-layer="education">
                            <label class="form-check-label" for="showEducation">
                                <i class="fas fa-school"></i> Schools & Universities
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Healthcare -->
                <div class="row mb-3">
                    <div class="col-lg-12">
                        <h6 class="text-danger"><i class="fas fa-heartbeat"></i> Healthcare</h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showHealthcare" data-layer="healthcare">
                            <label class="form-check-label" for="showHealthcare">
                                <i class="fas fa-hospital"></i> Hospitals & Clinics
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Culture -->
                <div class="row mb-3">
                    <div class="col-lg-12">
                        <h6 class="text-warning"><i class="fas fa-palette"></i> Culture & Entertainment</h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showCulture" data-layer="culture">
                            <label class="form-check-label" for="showCulture">
                                <i class="fas fa-theater-masks"></i> Museums & Theaters
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Tourism -->
                <div class="row mb-3">
                    <div class="col-lg-12">
                        <h6 class="text-info"><i class="fas fa-map-marked-alt"></i> Tourism</h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showTourism" data-layer="tourism">
                            <label class="form-check-label" for="showTourism">
                                <i class="fas fa-bed"></i> Hotels & Hostels
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Food -->
                <div class="row mb-3">
                    <div class="col-lg-12">
                        <h6 class="text-secondary"><i class="fas fa-utensils"></i> Food & Drink</h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showFood" data-layer="food">
                            <label class="form-check-label" for="showFood">
                                <i class="fas fa-coffee"></i> Restaurants & Cafes
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Shopping -->
                <div class="row mb-3">
                    <div class="col-lg-12">
                        <h6 class="text-dark"><i class="fas fa-shopping-cart"></i> Shopping</h6>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input layer-toggle" type="checkbox" id="showShopping" data-layer="shopping">
                            <label class="form-check-label" for="showShopping">
                                <i class="fas fa-store"></i> Shops & Markets
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="row mt-3">
                    <div class="col-lg-12">
                        <button class="btn btn-sm btn-primary" id="selectAll">
                            <i class="fas fa-check-square"></i> Select All
                        </button>
                        <button class="btn btn-sm btn-secondary" id="deselectAll">
                            <i class="fas fa-square"></i> Deselect All
                        </button>
                        <button class="btn btn-sm btn-success" id="refreshMap">
                            <i class="fas fa-sync"></i> Refresh Map
                        </button>
                        <button class="btn btn-sm btn-danger" id="exportPDF">
                            <i class="fas fa-file-alt"></i> Export Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="row">
        <div class="col-lg-8">
            <div id="map"></div>
        </div>
        
        <div class="col-lg-4">
            <!-- Legend -->
            <div class="legend mb-4">
                <h5><i class="fas fa-palette"></i> Legend</h5>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff6b6b;"></div>
                    <span>Buildings</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4ecdc4;"></div>
                    <span>Roads</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #45b7d1;"></div>
                    <span>Waterways</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #28a745;"></div>
                    <span>Education</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #dc3545;"></div>
                    <span>Healthcare</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffc107;"></div>
                    <span>Culture</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #17a2b8;"></div>
                    <span>Tourism</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #6c757d;"></div>
                    <span>Food & Drink</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #343a40;"></div>
                    <span>Shopping</span>
                </div>
            </div>

            <!-- Statistics -->
            <div class="legend">
                <h5><i class="fas fa-chart-bar"></i> Map Statistics</h5>
                <div id="mapStats">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statBuildings">{{ way_analysis.get('buildings', 0) }}</strong>
                                <br><small>Buildings</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statRoads">{{ way_analysis.get('roads', 0) }}</strong>
                                <br><small>Roads</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statWaterways">{{ way_analysis.get('waterways', 0) }}</strong>
                                <br><small>Waterways</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statEducation">{{ way_analysis.get('amenities', 0) }}</strong>
                                <br><small>Education</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statHealthcare">{{ way_analysis.get('amenities', 0) }}</strong>
                                <br><small>Healthcare</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statCulture">{{ way_analysis.get('amenities', 0) }}</strong>
                                <br><small>Culture</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statTourism">{{ way_analysis.get('amenities', 0) }}</strong>
                                <br><small>Tourism</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statFood">{{ way_analysis.get('amenities', 0) }}</strong>
                                <br><small>Food & Drink</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-2">
                                <strong id="statShopping">{{ way_analysis.get('amenities', 0) }}</strong>
                                <br><small>Shopping</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bounds Info -->
            {% if bounds %}
            <div class="legend mt-3">
                <h5><i class="fas fa-globe"></i> Bounds</h5>
                <small>
                    <strong>SW:</strong> {{ "%.4f"|format(bounds.minlat) }}, {{ "%.4f"|format(bounds.minlon) }}<br>
                    <strong>NE:</strong> {{ "%.4f"|format(bounds.maxlat) }}, {{ "%.4f"|format(bounds.maxlon) }}<br>
                    <strong>Size:</strong> {{ "%.4f"|format(bounds.maxlat - bounds.minlat) }}° × {{ "%.4f"|format(bounds.maxlon - bounds.minlon) }}°
                </small>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Map Info -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Note:</strong> This is a simplified map view showing the geographic bounds and feature distribution of your OSM data. 
                For detailed interactive mapping, consider using tools like QGIS or web mapping libraries like Leaflet.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map
    const map = L.map('map').setView([0, 0], 2);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Store all markers and layers
    let allMarkers = [];
    let currentBounds = null;
    
    // Color scheme for different layer types
    const layerColors = {
        buildings: '#ff6b6b',
        roads: '#4ecdc4',
        waterways: '#45b7d1',
        education: '#28a745',
        healthcare: '#dc3545',
        culture: '#ffc107',
        tourism: '#17a2b8',
        food: '#6c757d',
        shopping: '#343a40'
    };
    
    // Initialize map with bounds
    const bounds = {{ bounds | tojson if bounds else 'null' }};
    if (bounds) {
        const southWest = L.latLng(bounds.minlat, bounds.minlon);
        const northEast = L.latLng(bounds.maxlat, bounds.maxlon);
        currentBounds = [southWest, northEast];
        
        // Fit map to bounds
        map.fitBounds(currentBounds);
        
        // Add bounds rectangle
        const bounds_rect = L.rectangle(currentBounds, {
            color: '#ff7800',
            fillColor: '#ff7800',
            fillOpacity: 0.1,
            weight: 3
        }).addTo(map);
        
        bounds_rect.bindPopup(`
            <strong>OSM Data Bounds</strong><br>
            Southwest: ${bounds.minlat.toFixed(6)}, ${bounds.minlon.toFixed(6)}<br>
            Northeast: ${bounds.maxlat.toFixed(6)}, ${bounds.maxlon.toFixed(6)}<br>
            Size: ${(bounds.maxlat - bounds.minlat).toFixed(6)}° × ${(bounds.maxlon - bounds.minlon).toFixed(6)}°
        `);
    }
    
    // Load initial map data
    loadMapData();
    
    // Function to load map data from API
    function loadMapData() {
        const checkboxes = document.querySelectorAll('.layer-toggle');
        const params = new URLSearchParams();
        
        checkboxes.forEach(checkbox => {
            params.append(checkbox.dataset.layer, checkbox.checked);
        });
        
        fetch(`/api/map_data?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                updateMapWithData(data);
                updateStatistics(data);
            })
            .catch(error => {
                console.error('Error loading map data:', error);
            });
    }
    
    // Function to update map with new data
    function updateMapWithData(data) {
        // Clear existing markers
        allMarkers.forEach(marker => map.removeLayer(marker));
        allMarkers = [];
        
        if (!data || !data.bounds) return;
        
        // Add markers for ways (buildings, roads, etc.)
        Object.values(data.ways || {}).forEach(way => {
            if (way.nodes && way.nodes.length > 0) {
                // Get coordinates from first node
                const firstNodeId = way.nodes[0];
                const nodeData = data.nodes?.[firstNodeId];
                
                if (nodeData) {
                    const marker = createMarkerForWay(nodeData.lat, nodeData.lon, way.tags);
                    if (marker) {
                        allMarkers.push(marker);
                        marker.addTo(map);
                    }
                }
            }
        });
        
        // Add markers for amenity nodes
        Object.values(data.nodes || {}).forEach(node => {
            if (node.tags && node.tags.amenity) {
                const marker = createMarkerForAmenity(node.lat, node.lon, node.tags);
                if (marker) {
                    allMarkers.push(marker);
                    marker.addTo(map);
                }
            }
        });
    }
    
    // Function to create marker for ways
    function createMarkerForWay(lat, lon, tags) {
        let layerType = 'other';
        let iconHtml = '';
        
        if (tags.building) {
            layerType = 'buildings';
            iconHtml = '<div style="background-color:#ff6b6b;width:10px;height:10px;border-radius:2px;"></div>';
        } else if (tags.highway) {
            layerType = 'roads';
            iconHtml = '<div style="background-color:#4ecdc4;width:12px;height:2px;"></div>';
        } else if (tags.waterway) {
            layerType = 'waterways';
            iconHtml = '<div style="background-color:#45b7d1;width:10px;height:10px;border-radius:50%;"></div>';
        }
        
        if (iconHtml) {
            return L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [12, 12]
                })
            }).bindPopup(`
                <strong>${layerType.charAt(0).toUpperCase() + layerType.slice(1)}</strong><br>
                ${Object.entries(tags).map(([key, value]) => `${key}: ${value}`).join('<br>')}
            `);
        }
        
        return null;
    }
    
    // Function to create marker for amenities
    function createMarkerForAmenity(lat, lon, tags) {
        const amenity = tags.amenity;
        let layerType = 'other';
        let color = '#666666';
        
        if (['school', 'university', 'college', 'kindergarten'].includes(amenity)) {
            layerType = 'education';
            color = layerColors.education;
        } else if (['hospital', 'clinic', 'pharmacy', 'doctors'].includes(amenity)) {
            layerType = 'healthcare';
            color = layerColors.healthcare;
        } else if (['museum', 'theatre', 'cinema', 'library', 'arts_centre'].includes(amenity)) {
            layerType = 'culture';
            color = layerColors.culture;
        } else if (['hotel', 'guest_house', 'hostel', 'tourist_info'].includes(amenity)) {
            layerType = 'tourism';
            color = layerColors.tourism;
        } else if (['restaurant', 'cafe', 'bar', 'fast_food'].includes(amenity)) {
            layerType = 'food';
            color = layerColors.food;
        } else if (['shop', 'supermarket', 'marketplace'].includes(amenity)) {
            layerType = 'shopping';
            color = layerColors.shopping;
        }
        
        return L.marker([lat, lon], {
            icon: L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color:${color};width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,
                iconSize: [16, 16]
            })
        }).bindPopup(`
            <strong>${amenity.charAt(0).toUpperCase() + amenity.slice(1)}</strong><br>
            ${tags.name || 'Unnamed'}<br>
            Type: ${layerType}
        `);
    }
    
    // Function to update statistics
    function updateStatistics(data) {
        const stats = {
            buildings: 0,
            roads: 0,
            waterways: 0,
            education: 0,
            healthcare: 0,
            culture: 0,
            tourism: 0,
            food: 0,
            shopping: 0
        };
        
        // Count ways
        Object.values(data.ways || {}).forEach(way => {
            const tags = way.tags;
            if (tags.building) stats.buildings++;
            else if (tags.highway) stats.roads++;
            else if (tags.waterway) stats.waterways++;
        });
        
        // Count amenities
        Object.values(data.nodes || {}).forEach(node => {
            const amenity = node.tags?.amenity;
            if (['school', 'university', 'college', 'kindergarten'].includes(amenity)) stats.education++;
            else if (['hospital', 'clinic', 'pharmacy', 'doctors'].includes(amenity)) stats.healthcare++;
            else if (['museum', 'theatre', 'cinema', 'library', 'arts_centre'].includes(amenity)) stats.culture++;
            else if (['hotel', 'guest_house', 'hostel', 'tourist_info'].includes(amenity)) stats.tourism++;
            else if (['restaurant', 'cafe', 'bar', 'fast_food'].includes(amenity)) stats.food++;
            else if (['shop', 'supermarket', 'marketplace'].includes(amenity)) stats.shopping++;
        });
        
        // Update DOM
        Object.keys(stats).forEach(key => {
            const element = document.getElementById(`stat${key.charAt(0).toUpperCase() + key.slice(1)}`);
            if (element) {
                element.textContent = stats[key];
            }
        });
    }
    
    // Event listeners for checkboxes
    document.querySelectorAll('.layer-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', loadMapData);
    });
    
    // Event listeners for control buttons
    document.getElementById('selectAll').addEventListener('click', function() {
        document.querySelectorAll('.layer-toggle').forEach(checkbox => {
            checkbox.checked = true;
        });
        loadMapData();
    });
    
    document.getElementById('deselectAll').addEventListener('click', function() {
        document.querySelectorAll('.layer-toggle').forEach(checkbox => {
            checkbox.checked = false;
        });
        loadMapData();
    });
    
    document.getElementById('refreshMap').addEventListener('click', loadMapData);
    
    // PDF Export functionality
    document.getElementById('exportPDF').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.layer-toggle');
        const params = new URLSearchParams();
        
        checkboxes.forEach(checkbox => {
            params.append(checkbox.dataset.layer, checkbox.checked);
        });
        
        // Create download link
        const downloadUrl = `/export_map_pdf?${params.toString()}`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = 'osm_map_report.txt';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message
        const button = this;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        button.disabled = true;
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 2000);
    });
});
</script>
{% endblock %}
